package com.bmc.ctm.hfmcli;

import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;

public final class HfmLoginProbe2 {
    private static Class<?> clz(String n) throws ClassNotFoundException { return Class.forName(n); }
    private static Object newI(Class<?> c) throws Exception {
        try { return c.getDeclaredConstructor().newInstance(); } catch (NoSuchMethodException e) { return c.newInstance(); }
    }
    private static Object call(Object t, String n, Class<?>[] sig, Object... args) throws Exception {
        Method m = t.getClass().getMethod(n, sig); m.setAccessible(true); return m.invoke(t, args);
    }
    private static Object callS(Class<?> c, String n, Class<?>[] sig, Object... args) throws Exception {
        Method m = c.getMethod(n, sig); m.setAccessible(true); return m.invoke(null, args);
    }
    private static Object sret(Class<?> c, String n, Class<?>[] sig, Object... args) {
        try { return callS(c, n, sig, args); } catch (Throwable e) { return null; }
    }
    private static Object cret(Object t, String n, Class<?>[] sig, Object... args) {
        try { return call(t, n, sig, args); } catch (Throwable e) { return null; }
    }

    private static String prop(String k) {
        String v = System.getProperty(k);
        if (v != null && v.trim().isEmpty()) v = null;
        return v;
    }

    public static void main(String[] args) throws Exception {
        System.out.println("=== HfmLoginProbe2 ===");

        String userProp = prop("HFM_USER");        // e.g. GEHC\223115422  or  223115422
        String pass     = prop("HFM_PASSWORD");
        String cluster  = null;
        String provider = null;
        String domain   = null;
        String server   = null;

        // Optional CLI flags: --cluster X --provider X --domain X --server X
        Map<String,String> cli = new LinkedHashMap<>();
        String k = null;
        for (String a : args) {
            if (a.startsWith("--")) { k = a.substring(2); cli.put(k, "true"); }
            else if (k != null) { cli.put(k, a); k = null; }
        }
        if (cli.get("cluster")  != null && !"true".equals(cli.get("cluster")))  cluster  = cli.get("cluster");
        if (cli.get("provider") != null && !"true".equals(cli.get("provider"))) provider = cli.get("provider");
        if (cli.get("domain")   != null && !"true".equals(cli.get("domain")))   domain   = cli.get("domain");
        if (cli.get("server")   != null && !"true".equals(cli.get("server")))   server   = cli.get("server");

        System.out.println("userProp=" + userProp);
        System.out.println("cluster=" + cluster + " domain=" + domain + " server=" + server + " provider=" + provider);

        if (userProp == null || pass == null) {
            System.out.println("ERROR: set -DHFM_USER and -DHFM_PASSWORD system properties.");
            System.exit(2);
        }

        // Build username permutations for AD:
        // - raw (as provided)
        // - strip domain prefix "DOMAIN\user"
        // - UPN "user@domain" if domain is given
        String baseUser = userProp;
        String prefixDomain = null;
        if (userProp.contains("\\")) {
            String[] parts = userProp.split("\\\\", 2);
            if (parts.length == 2) { prefixDomain = parts[0]; baseUser = parts[1]; }
        }
        List<String> userTries = Arrays.asList(
            userProp,
            baseUser,
            (domain != null ? baseUser + "@" + domain : null),
            (prefixDomain != null ? baseUser + "@" + prefixDomain : null)
        );

        String[] factories = {
            "oracle.epm.fm.common.service.ServiceClientFactory",
            "oracle.epm.fm.common.service.client.ServiceClientFactory"
        };
        String[] secGetters = { "getSecurityService", "getSecurityClient", "security", "getSecurity" };
        String[] loginNames = { "login", "authenticate", "logon" };

        Object session = null;
        for (String fqn : factories) {
            try {
                Class<?> facClz = clz(fqn);
                Object factory = sret(facClz, "getInstance", new Class<?>[]{});
                if (factory == null) { try { factory = newI(facClz); } catch (Throwable ignore) {} }
                if (factory == null) { System.out.println("[diag] no factory instance via " + fqn); continue; }

                if (provider != null) { cret(factory, "setProvider",    new Class<?>[]{String.class}, provider);
                                        cret(factory, "setProviderURL", new Class<?>[]{String.class}, provider);
                                        cret(factory, "setProviderUrl", new Class<?>[]{String.class}, provider); }
                if (domain   != null) { cret(factory, "setDomain",      new Class<?>[]{String.class}, domain);
                                        cret(factory, "setDomainName",  new Class<?>[]{String.class}, domain); }
                if (server   != null) { cret(factory, "setServer",      new Class<?>[]{String.class}, server);
                                        cret(factory, "setServerName",  new Class<?>[]{String.class}, server); }
                if (cluster  != null) { cret(factory, "setCluster",     new Class<?>[]{String.class}, cluster);
                                        cret(factory, "setClusterName", new Class<?>[]{String.class}, cluster); }

                Object sec = null;
                for (String g : secGetters) {
                    sec = cret(factory, g, new Class<?>[]{});
                    if (sec != null) break;
                }
                if (sec == null) { System.out.println("[diag] security getter failed on " + fqn); continue; }

                if (provider != null) { cret(sec, "setProvider",    new Class<?>[]{String.class}, provider);
                                        cret(sec, "setProviderURL", new Class<?>[]{String.class}, provider);
                                        cret(sec, "setProviderUrl", new Class<?>[]{String.class}, provider); }
                if (domain   != null) { cret(sec, "setDomain",      new Class<?>[]{String.class}, domain);
                                        cret(sec, "setDomainName",  new Class<?>[]{String.class}, domain); }
                if (server   != null) { cret(sec, "setServer",      new Class<?>[]{String.class}, server);
                                        cret(sec, "setServerName",  new Class<?>[]{String.class}, server); }
                if (cluster  != null) { cret(sec, "setCluster",     new Class<?>[]{String.class}, cluster);
                                        cret(sec, "setClusterName", new Class<?>[]{String.class}, cluster); }

                for (String utry : userTries) {
                    if (utry == null) continue;
                    for (String ln : loginNames) {
                        // 3-arg variants
                        session = cret(sec, ln, new Class<?>[]{String.class,String.class,String.class}, utry, pass, cluster);
                        if (session != null) { System.out.println("SUCCESS via "+ln+"("+utry+",*,cluster)"); printSession(session); return; }
                        session = cret(sec, ln, new Class<?>[]{String.class,String.class,String.class}, utry, pass, domain);
                        if (session != null) { System.out.println("SUCCESS via "+ln+"("+utry+",*,domain)");  printSession(session); return; }
                        // 2-arg
                        session = cret(sec, ln, new Class<?>[]{String.class,String.class}, utry, pass);
                        if (session != null) { System.out.println("SUCCESS via "+ln+"("+utry+",*)");         printSession(session); return; }
                    }
                }
            } catch (Throwable e) {
                System.out.println("[diag] factory try failed: " + fqn + " -> " + e.getClass().getSimpleName() + ": " + e.getMessage());
            }
        }
        System.out.println("RESULT: Login still NULL. Check user format, domain, provider, HSS provisioning, and HFM security mode.");
        System.exit(5);
    }

    private static void printSession(Object session) {
        try {
            Method getSid = session.getClass().getMethod("getSessionId");
            Object sid = getSid.invoke(session);
            System.out.println("SessionInfo class = " + session.getClass().getName());
            System.out.println("SessionId = " + (sid == null ? "<null>" : sid.toString()));
        } catch (Throwable t) {
            System.out.println("SessionInfo object but cannot read SessionId: " + t.getMessage());
        }
    }
}
